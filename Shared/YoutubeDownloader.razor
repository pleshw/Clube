@using Clube.Data
@using System.Text.RegularExpressions;
@using YoutubeExplode.Common;
@implements IObserver<double>
@inject YoutubeDownloaderService DownloaderService

<YoutubeLogo Width="40%" Height="40%"></YoutubeLogo>

<form @onsubmit="@DownloadVideoFromURL" class="row justify-content-center">

    <div class="mb-3 col-12 row mt-4 px-5">
        <InputText @bind-Value="YoutubeURLInputValue" class="form-control" placeholder="link do vídeo" id="youtubeURLToDownload" />
    </div>

    @if (!string.IsNullOrEmpty( videoURL ) && !string.IsNullOrEmpty( thumbURL ) && !string.IsNullOrEmpty( videoTitle ) )
    {
        <div class="col-10">
            <VideoThumbnail ThumbURL="@thumbURL" VideoTitle="@videoTitle" VideoURL="@videoURL"></VideoThumbnail>
        </div>
    }

    @if (isDownloading)
    {
        <button type="submit" class="btn btn-outline-danger col-6" disabled>@downloadProgress.ToString()%</button>
    }
    else
    {
        <button type="submit" class="btn btn-outline-danger col-6">Salvar</button>
    }
</form>

@code {
    public static int downloadProgress = 0;

    public static string thumbURL = "";
    public static string videoTitle = "";
    public static string videoURL = "";

    public static bool downloadCompleted = false;
    public static bool downloadError = false;
    public static bool isDownloading = false;

    public YoutubeDownloaderService? downloaderService;
    private string youtubeURLInputValue  = "";

    private string YoutubeURLInputValue 
    { 
        get
        {
            return youtubeURLInputValue;
        }
        set
        {
            youtubeURLInputValue = value;
            InvokeAsync(DisplayThumbnailIfAvailable);
        } 
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ClearForm();
        downloaderService = new YoutubeDownloaderService(new ProgressTracker(this));
        InvokeAsync( StateHasChanged );
    }

    public void ClearForm()
    {
        youtubeURLInputValue = "";
        thumbURL = "";
        videoTitle = "";
        videoURL = "";
        StateHasChanged();
    }

    public async Task DisplayThumbnailIfAvailable()
    {
        if (!string.IsNullOrEmpty( youtubeURLInputValue ))
        {
            var regexYoutubeVideoUrl = new Regex(@"^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube(-nocookie)?\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|live\/|v\/)?)([\w\-]+)(\S+)?$");
            if (regexYoutubeVideoUrl.Match( youtubeURLInputValue ).Success)
            {
                var videoMetadata = await downloaderService!.GetVideoMetadata( youtubeURLInputValue );
                thumbURL = videoMetadata.Thumbnails.GetWithHighestResolution().Url;
                videoTitle = videoMetadata.Title;
                videoURL = youtubeURLInputValue;
                StateHasChanged();
            }
        }
    }

    public async Task DownloadVideoFromURL()
    {
        if (!string.IsNullOrEmpty( youtubeURLInputValue ) && !isDownloading)
        {
            await downloaderService!.GetVideoAsync( youtubeURLInputValue );
        }
    }

    public void OnCompleted()
    {
        isDownloading = false;
        downloadCompleted = true;
        ClearForm();
    }

    public void OnError( Exception error )
    {
        isDownloading = false;
        downloadError = true;
        ClearForm();
    }

    public void OnNext( double value )
    {
        isDownloading = true;
        downloadProgress = (int)double.Round( value * 100 );
        StateHasChanged();
    }
}
